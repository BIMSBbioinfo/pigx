---
title: "SARS-CoV-2 Variants of Concern - Time series report"
nav: "Timecourse"
date: '`r format(as.POSIXct(if ("" != Sys.getenv("SOURCE_DATE_EPOCH")) { as.numeric(Sys.getenv("SOURCE_DATE_EPOCH")) } else { Sys.time() }, origin="1970-01-01"), "%Y-%m-%d %H:%M:%S")`'
params:
  variants_csv: ''
  mutations_csv: ''
---

```{r libraries and input, echo=F, message=F, warning=F}
library(plotly)
library(htmltools)
library(reshape2)

df_var <- read.table(params$variants_csv, sep = "\t", header=T)
df_mut <- read.table(params$mutations_csv, sep = "\t", header=T)
```

# VARIANTS

## Frequency of virus strains over time for each location
```{r variants, echo=F, message=F, warning=F}

melted <- reshape2::melt(df_var,
                         id.vars = c("dates", "samplename", "location_name",
                                     "coordinates_lat", "coordinates_long"))
melted$dates <- as.Date(melted$dates)
locations <- unique(melted$location_name)

tagList(lapply(locations,
               function (location) {
                   subset(melted, location_name == location) %>%
                       group_by(dates) %>%
                       arrange(variable) %>%
                       mutate (value = round (value, 4)) %>%
                       plot_ly (type = 'scatter',
                                mode = 'line',
                                stackgroup = 'one',
                                showlegend = TRUE,
                                x = ~dates,
                                y = ~value,
                                color = ~variable) %>%
                       layout (title = location)
               }))
```


## Virus strains per date and location

On this map you can see where different virus strains and their
relative frequencies have been detected at specific locations over
time.  Use the slider to select a specific date or hit the Play button
to display all snapshots successively.

Use the slider to select a specific date or hit the Play button to display all snapshots successively. By 
double-clicking on the variants displayed on the legend the chosen variants can be disabled.

```{r maps for variants, echo=F}

melted <- melt(df_var,
               id.vars = c("dates", "samplename", "location_name",
                           "coordinates_lat", "coordinates_long"))
plot_ly (data = melted,
         type = 'scattermapbox',
         mode = 'markers') %>%
    add_trace(size = 1,
              lon = ~coordinates_long,
              lat = ~coordinates_lat,
              name = ~variable,
              legendgroup = ~variable,
              opacity = 0.1,
              showlegend = FALSE,
              marker = list(sizemode = 'diameter',
                            color = 'rgb(150, 150, 150)',
                            opacity = 0.1)) %>%
    add_trace(lat = ~coordinates_lat,
              lon = ~coordinates_long,
              legendgroup = ~variable,
              showlegend = TRUE,
              frame = ~dates,
              size = ~value,
              text = ~value,
              color = ~variable,
              hovertemplate = 'Frequency: %{text}',
              marker = list (sizemode = 'diameter')) %>%
    layout (mapbox = list (zoom = 5.5,
                           center = list(lat = ~median(coordinates_lat, na.rm=TRUE),
                                         lon = ~median(coordinates_long, na.rm=TRUE)),
                           style = 'open-street-map'))
```


# MUTATIONS

## mutations  over time for each location 
```{r mutations, echo=F, message=F, warning=F}
melted <- reshape2::melt(df_mut,
                         id.vars = c("dates", "samplename", "location_name",
                                     "coordinates_lat", "coordinates_long"))
melted$dates <- as.Date(melted$dates)

# sort by dates
idx <- order(melted$dates)
melted <- melted[idx, ]

locations <- unique(melted$location_name)

tagList(lapply(locations,
               function (location) {
                   subset(melted, location_name == location) %>%
                       group_by(dates) %>%
                       arrange(variable) %>%
                       plot_ly(type = 'scatter',
                               mode = 'line',
                               name = ~variable,
                               x = ~dates,
                               y = ~value) %>%
                       layout(title = location)
               }))
```

## mutations on the map for each data/location

On this map you see the detected genetic mutations at specific
locations over time.  Use the slider to select a specific date or hit
the Play button to display all snapshots successively.

Use the slider to select a specific date or hit the Play button to display all snapshots successively.

```{r mutations for locations and date, echo=F}
melted <- melt(df_mut,
               id.vars = c("dates", "samplename", "location_name",
                           "coordinates_lat", "coordinates_long"))
plot_ly (data = melted,
         type = 'scattermapbox',
         mode = 'markers',
         size = ~value,
         lon = ~coordinates_long,
         lat = ~coordinates_lat,
         name = ~variable,
         color = ~variable,
         text = ~value,
         fill = 'none',
         frame = ~dates,
         marker = list (sizemode = 'diameter',
                        opacity = 0.4),
         hovertemplate = 'Frequency: %{text}') %>%
    layout (title = ~dates,
            mapbox = list (zoom = 5.5,
                           center = list(lat = ~median(coordinates_lat, na.rm=TRUE),
                                         lon = ~median(coordinates_long, na.rm=TRUE)),
                           style = 'open-street-map'))
```
